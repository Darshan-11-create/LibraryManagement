<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="stylesheet" href="home.css">
    <style>
        /* Loading Overlay */

    </style>
</head>

<body>
    <!-- Loading Overlay with Animated Book -->
   <div class="center-loading" id="centerLoader">
    <div class="book">
        <div class="book-inner">
            <div class="book-spine"></div>
            <div class="pages-container">
                <div class="page page1"></div>
                <div class="page page2"></div>
                <div class="page page3"></div>
                <div class="page page4"></div>
                <div class="page page5"></div>
                <div class="page page6"></div>
            </div>
        </div>
    </div>
    <div class="loading-text">PROCESSING REQUESTâ€¦</div>
</div>


    <h1>Find Your Favourate Book</h1>
    <div class="profile" id="pro">
        <img src="user.png" alt="">
    </div>
    <div class="box1">
        <img src="home.png" id="image">
        <input type="text" id="search" placeholder="Search Your Book">
        <div class="box2">
            <h1>Add Filters</h1>
            <label for=""><input type="checkbox" id="price1" value="low-high" name="price11">low-high</label>
            <label><input type="checkbox" id="price2" value="high-low" name="price12">high-low</label>
            <label>Price:-<span id="price">10000</span>
                <input type="range" min="500" max="10000" step="100" id="Range" value="10000"
                    oninput="document.getElementById('price').innerText=this.value"></label>
            <label><input type="checkbox" id="avai" value="Available" name="availa">AvailableBooks</label>
        </div>
    </div>
    <div id="container"></div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
   <script src="connectSocket.js"></script>
    <script>
        const container = document.getElementById("container");
const token = localStorage.getItem("token");
const username = localStorage.getItem("name");

let allBooks = [];
let data2 = [];
let cust_id;

/* ---------------- LOADER ---------------- */
const centerLoader = document.getElementById("centerLoader");
function showCenterLoading() {
    centerLoader.classList.add("active");
}
function hideCenterLoading() {
    centerLoader.classList.remove("active");
}

/* ---------------- FETCH ALL BOOKS ---------------- */
async function fetchData() {
    const res = await fetch(
        "https://librarymanagementbackend-d5pk.onrender.com/AvailableBooks",
        { headers: { Authorization: `Bearer ${token}` } }
    );
    allBooks = await res.json();
    data2 = [...allBooks];
    fetchBooks(data2);
}

/* ---------------- SEARCH ---------------- */
document.getElementById("search").addEventListener("keyup", async (e) => {
    const value = e.target.value.trim();

    if (value === "") {
        data2 = [...allBooks];
        applyfilter();
        return;
    }

    const res = await fetch(
        `https://librarymanagementbackend-d5pk.onrender.com/SearchBooks?name=${value}`,
        { headers: { Authorization: `Bearer ${token}` } }
    );

    data2 = await res.json();
    applyfilter();
});

/* ---------------- FILTERS ---------------- */
const cd1 = document.getElementById("price1");
const cd2 = document.getElementById("price2");
const cd4 = document.getElementById("avai");
const range = document.getElementById("Range");

function applyfilter() {
    let filtered = [...data2];

    // price
    const max = Number(range.value);
    filtered = filtered.filter(b => b.price <= max);

    // availability
    if (cd4.checked) {
        filtered = filtered.filter(b => !b.Rented && !b.bought);
    }

    // sorting
    if (cd1.checked && !cd2.checked) {
        filtered.sort((a, b) => a.price - b.price);
    }
    if (cd2.checked && !cd1.checked) {
        filtered.sort((a, b) => b.price - a.price);
    }

    fetchBooks(filtered);
}

// make price sort exclusive
cd1.addEventListener("change", () => cd2.checked = false);
cd2.addEventListener("change", () => cd1.checked = false);
range.addEventListener("input", applyfilter);
cd4.addEventListener("change", applyfilter);

/* ---------------- RENDER ---------------- */
function fetchBooks(data) {
    container.innerHTML = "";

    if (!data.length) {
        container.innerHTML = "<p>No books found</p>";
        return;
    }

    container.innerHTML = data.map(item => `
        <div class="box" bookid="${item.id}">
            <p>BookName: ${item.bookName}</p>
            <p>Author: ${item.bookAuthorName}</p>
            <p>Price: ${item.price}</p>
            <p class="avail">
                ${item.Rented ? "Taken For Rent" : item.bought ? "Already Bought" : "Available"}
            </p>
            <div class="button">
                <button>Buy</button>
                <button>Rent</button>
            </div>
        </div>
    `).join("");
}

/* ---------------- CUSTOMER ---------------- */
async function loadCustomer() {
    showCenterLoading();
    const res = await fetch(
        `https://librarymanagementbackend-d5pk.onrender.com/CustomerDetails?name=${username}`,
        { headers: { Authorization: `Bearer ${token}` } }
    );
    const data = await res.json();
    cust_id = data.id;
    hideCenterLoading();
}

loadCustomer();
fetchData();

/* ---------------- BUY / RENT ---------------- */
container.addEventListener("click", async (e) => {
    if (e.target.tagName !== "BUTTON") return;

    const box = e.target.closest(".box");
    const id = box.getAttribute("bookid");
    const action = e.target.textContent;

    const url = action === "Buy"
        ? `https://librarymanagementbackend-d5pk.onrender.com/PurchaseBook?id=${id}&cust_id=${cust_id}`
        : `https://librarymanagementbackend-d5pk.onrender.com/RentBook?id=${id}&cust_id=${cust_id}`;

    showCenterLoading();
    await fetch(url, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` }
    });
    hideCenterLoading();
});

      </script>
</body>

</html>