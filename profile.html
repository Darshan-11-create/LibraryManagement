<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="profile.css">
</head>

<body>
    <h1 id="header"></h1>
    <div id="info">
        <img src="user.png" alt="">
        <div id="user">

        </div>
    </div>
    <div id="totalbooks">
    </div>
    <h1>Books Bought:-</h1>
    <div id="boughtbooks">
    </div>
    <h1>Books Taken For Rent</h1>
    <div id="rentbooks">

    </div>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
   <script src="connectSocket.js"></script>
  <script>
     function dateformatter(date) {
                let year = date.getFullYear();
                let mon = String(date.getMonth() + 1).padStart(2, "0");
                let day = String(date.getDate()).padStart(2, "0");
                return `${year}-${mon}-${day}`
            }
          connectSocket(book=>{
            handleBookMessage(book)
          })
        function handleBookMessage(msg){
            const action=msg.action;
            const item=msg.book;
            if(action==="Rent")
              rentUpdater(item);
            else if(action==="Bought")
               boughtUpdater(item)
            else
              deleteBook(item)
            }
            function boughtUpdater(item){
                const bought = document.getElementById("boughtbooks");
            // let data = custdata.books.filter(b => b.bought);
                bought.innerHTML +=
                    `
                <div class="bookbought">
                   <p>Name=${item.bookName}</p>
                    <p>AuthorName=${item.bookAuthorName}</p>
                     <p>price=${item.price}</p>
                     <p>Date=${item.Taken}</p>
                </div>
                `
            }
            function rentUpdater(item){
                let date1 = new Date();
                date1 = dateformatter(date1);
            date1 = new Date(date1);
                let date2 = new Date(item.Taken);
                
                let days = Math.abs(date1 - date2) / (1000 * 60 * 60 * 24);
                console.log(days);
                let price = item.RentPrice * days;
                console.log(days)

                date2.setDate(date2.getDate() + 7);
                // date2=dateformatter(date2)
                let rdate = dateformatter(date2);
                const rent = document.getElementById("rentbooks");
                rent.innerHTML +=
               `
                <div class="bookbought">
                   <p>Name=${item.bookName}</p>
                    <p>AuthorName=${item.bookAuthorName}</p>
                     <p>Rent Price per Day=${item.RentPrice}</p>
                     <p>Date=${item.Taken}</p>
                     <p>Rent Price U have To Pay:-${price}</p>
                     <p>Expected Return Date:-${rdate}</p>
                </div>
              `
            }
            function deleteBook(item){

                const box=document.querySelector(`.box[bookid="${item.id}"]`);
                if(box)
                box.remove()
            }
        const token = localStorage.getItem("token");
        const username = localStorage.getItem("name")
        let custdata;
        async function name(params) {
            const res = await fetch(`https://librarymanagementbackend-d5pk.onrender.com/CustomerDetails?name=${username}`, {
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
            //  document.getElementById("header").innerHTML=`Welcome ${custdata.name}`;
            custdata = await res.json();
            document.getElementById("header").innerHTML = `Welcome ${custdata.name}`;
            const user = document.getElementById("user");
            user.innerHTML += `<p>Name=${custdata.name}</p>`
            user.innerHTML += `<p id="middle">Name=${custdata.email}</p>`
            user.innerHTML += `<p>Name=${custdata.phno}</p>`
            const bookdetails = document.getElementById("totalbooks");
            bookdetails.innerHTML += `<p id="header1">Total Books You Bought And Price</p>`
            bookdetails.innerHTML += `<p>TotalBooksBought=${custdata.totalbooksbought}</p>`
            bookdetails.innerHTML += `<p>TotalBooksRent=${custdata.totalbooksrent}</p>`
            bookdetails.innerHTML += `<p>TotalBooksprice=${custdata.totalprice - custdata.totalRentPrice}</p>`

            console.log(custdata);
            const bought = document.getElementById("boughtbooks");
            let data = custdata.books.filter(b => b.bought);
            console.log(data);
            data.forEach(item => {
              boughtUpdater(item)
            });
            const rent = document.getElementById("rentbooks");
            data = custdata.books.filter(b => b.Rented);
            console.log(data);
            
            data.forEach(item => {
                rentUpdater(item)
            });
        }
        name();
    </script>

</body>

</html>